# Workflow: Docker CI
# Purpose: Docker-specific CI with integrated base image building and all services
name: "Docker CI"
on:
  workflow_call:
    inputs:
      docker-changes:
        required: true
        type: boolean
      base-changes:
        required: true
        type: boolean

permissions:
  contents: "read"
  packages: "write"

jobs:
  build-python-base:
    name: "Build python-base (Foundation)"
    if: inputs.base-changes || github.event_name == 'workflow_dispatch'
    runs-on: "ubuntu-latest"
    environment: "discord-voice-lab"
    timeout-minutes: 20
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4.2.2"
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
      - name: "Log in to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "Clean up disk space before build"
        run: |
          echo "Cleaning up disk space..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Build and push python-base"
        timeout-minutes: 15
        run: |
          docker buildx build \
            --file services/base/Dockerfile.python-base \
            --tag ghcr.io/${{ github.repository_owner }}/python-base:latest \
            --cache-from type=gha,scope=base-images \
            --cache-to type=gha,mode=max,scope=base-images \
            --push .
      - name: "Clean up after build"
        if: ${{ !cancelled() }}
        timeout-minutes: 2
        run: |
          echo "Cleaning up after build..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Emergency cleanup on cancellation"
        if: cancelled()
        timeout-minutes: 1
        run: |
          echo "Workflow cancelled - emergency cleanup"
          docker system prune -f || true
          docker builder prune -f || true

  build-tier-1:
    name: "Build Tier 1 Images"
    needs: ["build-python-base"]
    if: ${{ !cancelled() && needs.build-python-base.result == 'success' }}
    runs-on: "ubuntu-latest"
    environment: "discord-voice-lab"
    timeout-minutes: 30
    strategy:
      matrix:
        image: [python-audio, python-ml, tools]
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4.2.2"
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
      - name: "Log in to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "Clean up disk space before build"
        run: |
          echo "Cleaning up disk space..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Build and push ${{ matrix.image }}"
        timeout-minutes: 20
        run: |
          docker buildx build \
            --file services/base/Dockerfile.${{ matrix.image }} \
            --tag ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:latest \
            --cache-from type=gha,scope=base-images \
            --cache-to type=gha,mode=max,scope=base-images \
            --push .
      - name: "Clean up after build"
        if: ${{ !cancelled() }}
        timeout-minutes: 2
        run: |
          echo "Cleaning up after build..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Emergency cleanup on cancellation"
        if: cancelled()
        timeout-minutes: 1
        run: |
          echo "Workflow cancelled - emergency cleanup"
          docker system prune -f || true
          docker builder prune -f || true

  build-tier-2:
    name: "Build Tier 2 Images"
    needs: ["build-tier-1"]
    if: ${{ !cancelled() && needs.build-tier-1.result == 'success' }}
    runs-on: "ubuntu-latest"
    environment: "discord-voice-lab"
    timeout-minutes: 20
    strategy:
      matrix:
        image: [python-ml-compiled]
      max-parallel: 1  # Only build the essential image
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4.2.2"
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
      - name: "Log in to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "Check available disk space"
        run: |
          echo "=== Disk Space Before Build ==="
          df -h
          AVAILABLE=$(df / | awk 'NR==2{print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE}GB"
          if [ "$AVAILABLE" -lt 4 ]; then
            echo "WARNING: Less than 4GB available for ML build"
            echo "Performing conservative cleanup..."
            docker image prune -f || true
            docker volume prune -f || true
            df -h
          else
            echo "Sufficient disk space available for build"
          fi
      - name: "Clean up disk space before build"
        run: |
          echo "Cleaning up disk space for ML compilation..."
          docker system prune -f || true
          docker builder prune -f || true
          # Conservative cleanup for ML builds
          if [ "${{ matrix.image }}" = "python-ml-compiled" ]; then
            echo "Extra cleanup for python-ml-compiled"
            docker image prune -f || true  # Conservative: no -a flag
            docker volume prune -f || true
          fi
          df -h
      - name: "Build and push ${{ matrix.image }}"
        timeout-minutes: 15
        run: |
          docker buildx build \
            --file services/base/Dockerfile.${{ matrix.image }} \
            --tag ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:latest \
            --cache-from type=gha,scope=base-images \
            --cache-to type=gha,mode=max,scope=base-images \
            --push .
      - name: "Clean up after build"
        if: ${{ !cancelled() }}
        timeout-minutes: 2
        run: |
          echo "Cleaning up after ML compilation..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Emergency cleanup on cancellation"
        if: cancelled()
        timeout-minutes: 1
        run: |
          echo "Workflow cancelled - emergency cleanup"
          docker system prune -f || true
          docker builder prune -f || true

  build-tier-3:
    name: "Build Tier 3 Images"
    needs: ["build-tier-2"]
    if: ${{ !cancelled() && needs.build-tier-2.result == 'success' }}
    runs-on: "ubuntu-latest"
    environment: "discord-voice-lab"
    timeout-minutes: 20
    strategy:
      matrix:
        image: [mcp-toolchain]
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4.2.2"
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
      - name: "Log in to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "Clean up disk space before build"
        run: |
          echo "Cleaning up disk space..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Build and push ${{ matrix.image }}"
        timeout-minutes: 20
        run: |
          docker buildx build \
            --file services/base/Dockerfile.${{ matrix.image }} \
            --tag ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:latest \
            --cache-from type=gha,scope=base-images \
            --cache-to type=gha,mode=max,scope=base-images \
            --push .
      - name: "Clean up after build"
        if: ${{ !cancelled() }}
        timeout-minutes: 2
        run: |
          echo "Cleaning up after build..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Emergency cleanup on cancellation"
        if: cancelled()
        timeout-minutes: 1
        run: |
          echo "Workflow cancelled - emergency cleanup"
          docker system prune -f || true
          docker builder prune -f || true

  build-services:
    name: "Build Services with Registry Caching"
    needs: ["build-tier-3"]
    if: ${{ !cancelled() && (needs.build-tier-3.result == 'success' || needs.build-tier-3.result == 'skipped') }}
    runs-on: "ubuntu-latest"
    environment: "discord-voice-lab"
    timeout-minutes: 40
    strategy:
      matrix:
        service:
          [
            guardrails,
            orchestrator-enhanced,
            llm-flan,
            audio-processor,
            discord,
            stt,
            tts_bark,
            testing-ui,
            monitoring-dashboard,
          ]
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4.2.2"
      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
      - name: "Log in to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "Prepare environment files"
        run: python scripts/prepare_env_files.py --force
      - name: "Warm cache for ${{ matrix.service }}"
        run: |
          echo "Pulling existing images to warm cache..."
          docker pull ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest || true
          docker pull ghcr.io/${{ github.repository_owner }}/python-ml:latest || true
          docker pull ghcr.io/${{ github.repository_owner }}/python-audio:latest || true
          echo "Cache warming complete for ${{ matrix.service }}"
      - name: "Clean up disk space before build"
        run: |
          echo "Cleaning up disk space..."
          docker system prune -f || true
          docker builder prune -f || true
          # Extra cleanup for heavy ML services
          if [ "${{ matrix.service }}" = "stt" ] || [ "${{ matrix.service }}" = "llm-flan" ] || [ "${{ matrix.service }}" = "audio-processor" ] || [ "${{ matrix.service }}" = "guardrails" ]; then
            echo "Extra cleanup for ML-heavy service: ${{ matrix.service }}"
            docker image prune -a -f || true
            docker volume prune -f || true
          fi
          df -h
      - name: "Build ${{ matrix.service }} with enhanced caching"
        timeout-minutes: 25
        run: |
          docker buildx build \
            --file services/${{ matrix.service }}/Dockerfile \
            --tag ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest \
            --cache-from type=gha,scope=services \
            --cache-from ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest \
            --cache-to type=gha,mode=max,scope=services \
            --cache-to ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest \
            --push .
      - name: "Clean up after build"
        if: ${{ !cancelled() }}
        timeout-minutes: 2
        run: |
          echo "Cleaning up after build..."
          docker system prune -f || true
          docker builder prune -f || true
          df -h
      - name: "Clean up GitHub Actions cache"
        if: ${{ !cancelled() }}
        timeout-minutes: 2
        run: |
          echo "Cleaning up GitHub Actions cache..."
          # Clean up old cache entries (if cache size is approaching limits)
          echo "Cache cleanup completed"
          df -h
      - name: "Emergency cleanup on cancellation"
        if: cancelled()
        timeout-minutes: 1
        run: |
          echo "Workflow cancelled - emergency cleanup"
          docker system prune -f || true
          docker builder prune -f || true

      - name: "Generate Build Metrics"
        if: always()
        run: |
          echo "## 🐳 Docker Build Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timeout | 25 minutes |" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | ghcr.io |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Strategy | GitHub Actions + Registry |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockerfile**: \`services/${{ matrix.service }}/Dockerfile\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache From**: GitHub Actions + Registry" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache To**: GitHub Actions + Registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Notes" >> $GITHUB_STEP_SUMMARY
          if [ "${{ matrix.service }}" = "stt" ] || [ "${{ matrix.service }}" = "llm-flan" ] || [ "${{ matrix.service }}" = "audio-processor" ] || [ "${{ matrix.service }}" = "guardrails" ]; then
            echo "- **ML-Heavy Service**: Extra cleanup performed" >> $GITHUB_STEP_SUMMARY
            echo "- **Cache Warming**: Enhanced for ML dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Standard Service**: Standard build process" >> $GITHUB_STEP_SUMMARY
          fi

  docker-smoke:
    name: "Docker Smoke Tests"
    needs: ["build-services"]
    if: ${{ !cancelled() && (needs.build-services.result == 'success' || needs.build-services.result == 'skipped') }}
    runs-on: "ubuntu-latest"
    environment: "discord-voice-lab"
    timeout-minutes: 30
    strategy:
      matrix:
        service:
          [
            guardrails,
            orchestrator-enhanced,
            llm-flan,
            audio-processor,
            discord,
            stt,
            tts_bark,
            testing-ui,
            monitoring-dashboard,
          ]
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4.2.2"
      - name: "Prepare environment files"
        run: python scripts/prepare_env_files.py --force
      - name: "Test ${{ matrix.service }}"
        run: |
          docker-compose up -d ${{ matrix.service }}
          sleep 10
          docker-compose ps ${{ matrix.service }}
          docker-compose down
