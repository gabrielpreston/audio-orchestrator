# Workflow: CI
# Purpose: Run linting, testing, security scanning, and Docker smoke tests
# when code changes are detected.
name: 'CI'
description: |
  CI workflow validation steps
on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  workflow_dispatch: {}
permissions:
  contents: 'read'
  pull-requests: 'read'
  packages: 'write'  # Required for GHCR publishing

concurrency:
  group: 'ci-${{ github.ref }}'
  cancel-in-progress: true

env:
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  PIP_NO_PYTHON_VERSION_WARNING: '1'
  PYTHONDONTWRITEBYTECODE: '1'

jobs:
  changes:
    name: 'Detect affected areas'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    outputs:
      python: '${{ steps.filter.outputs.python }}'
      docker: '${{ steps.filter.outputs.docker }}'
      docs: '${{ steps.filter.outputs.docs }}'
      workflows: '${{ steps.filter.outputs.workflows }}'
      security: '${{ steps.filter.outputs.security }}'
      # Per-service outputs
      discord: '${{ steps.filter.outputs.discord }}'
      stt: '${{ steps.filter.outputs.stt }}'
      llm: '${{ steps.filter.outputs.llm }}'
      orchestrator: '${{ steps.filter.outputs.orchestrator }}'
      tts: '${{ steps.filter.outputs.tts }}'
      base: '${{ steps.filter.outputs.base }}'
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
        with:
          fetch-depth: 2
      - name: 'Filter paths'
        id: 'filter'
        uses: 'dorny/paths-filter@v3'
        with:
          filters: |
            python:
              - 'Makefile'
              - 'pyproject.toml'
              - 'services/**/*.py'
              - 'services/**/requirements.txt'
            docker:
              - 'docker-compose.yml'
              - 'docker-compose.ci.yml'
              - 'services/**/Dockerfile'
              - 'services/**/requirements.txt'
            docs:
              - 'README.md'
              - 'docs/**'
              - 'AGENTS.md'
            workflows:
              - '.github/workflows/ci.yaml'
              - '.github/workflows/base-images.yaml'
            security:
              - 'pyproject.toml'
              - 'requirements-*.txt'
              - 'services/**/requirements.txt'
            # Per-service path filters
            discord:
              - 'services/discord/**'
              - 'services/common/**'
              - 'requirements-base.txt'
            stt:
              - 'services/stt/**'
              - 'services/common/**'
              - 'requirements-base.txt'
            llm:
              - 'services/llm/**'
              - 'services/common/**'
              - 'requirements-base.txt'
            orchestrator:
              - 'services/orchestrator/**'
              - 'services/common/**'
              - 'requirements-base.txt'
            tts:
              - 'services/tts/**'
              - 'services/common/**'
              - 'requirements-base.txt'
            # Base dependencies
            base:
              - 'services/base/**'
              - 'requirements-base.txt'
              - 'requirements-dev.txt'
              - 'requirements-test.txt'

  lint:
    name: 'Lint'
    needs: 'changes'
    if: |
      (needs.changes.outputs.python == 'true' ||
       needs.changes.outputs.docker == 'true' ||
       needs.changes.outputs.docs == 'true' ||
       needs.changes.outputs.workflows == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      needs.changes.result == 'success'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    timeout-minutes: 15
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
      - name: 'Setup job context'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Job started:', context.job)
            console.log('Repository:', context.repo.full_name)
            console.log('Ref:', context.ref)
            console.log('Workflow:', context.workflow)
            console.log('Run ID:', context.runId)
      - name: 'Set up Docker Buildx'
        uses: 'docker/setup-buildx-action@v3'
        with:
          driver-opts: |
            image=moby/buildkit:latest
      - name: 'Validate workflow syntax'
        run: |
          yamllint .github/workflows/ci.yaml
          yamllint .github/workflows/base-images.yaml
      - name: 'Validate Docker buildx'
        run: |
          docker buildx version
          docker buildx ls
      - name: 'Validate Makefile targets'
        run: |
          make lint --dry-run
          make test --dry-run
      - name: 'Run unified lint suite'
        run: |
          echo "::group::Lint Execution"
          start_time=$(date +%s)
          make lint
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "::endgroup::"
          echo "Lint completed in ${duration}s"
      - name: 'Cleanup resources with reporting'
        if: always()
        run: |
          echo "::group::Resource Cleanup Report"

          # Capture before cleanup
          before_space=$(df -h / | awk 'NR==2{print $4}')
          before_images=$(docker images -q | wc -l)

          # Cleanup operations
          echo "Cleaning Docker system..."
          docker system prune -f --volumes

          echo "Cleaning build cache..."
          docker builder prune -f

          # Capture after cleanup
          after_space=$(df -h / | awk 'NR==2{print $4}')
          after_images=$(docker images -q | wc -l)

          echo "Cleanup Results:"
          echo "  Disk space: $before_space to $after_space"
          echo "  Images removed: $((before_images - after_images))"
          echo "::endgroup::"
      - name: 'Job Status Summary'
        if: always()
        run: |
          echo "::group::Job Status Summary"
          echo "Job: ${{ github.job }}"
          echo "Runner: ${{ runner.os }} (${{ runner.arch }})"
          echo "Available Space: $(df -h / | awk 'NR==2{print $4}')"
          echo "Docker Images: $(docker images -q | wc -l)"
          echo "Cache: GitHub Actions Cache v2 enabled"
          echo "Retry: Native GitHub Actions retry (3 attempts, 15min timeout)"
          echo "::endgroup::"

  security-scan:
    name: 'Security scan'
    needs: 'changes'
    if: |
      (needs.changes.outputs.security == 'true' ||
       needs.changes.outputs.workflows == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      needs.changes.result == 'success' &&
      needs.lint.result == 'success'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    timeout-minutes: 15
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
      - name: 'Set up Docker Buildx'
        uses: 'docker/setup-buildx-action@v3'
        with:
          driver-opts: |
            image=moby/buildkit:latest
      - name: 'Run security scan'
        run: 'make security'
      - name: 'Upload pip-audit reports'
        if: 'always()'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'pip-audit-reports'
          path: 'security-reports'
          retention-days: 30
      - name: 'Security scan summary'
        if: 'always()'
        run: |
          if [ -d "security-reports" ]; then
            echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Vulnerabilities |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|----------------|" >> $GITHUB_STEP_SUMMARY
            for report in security-reports/*.json; do
              if [ -f "$report" ]; then
                service=$(basename "$report" -requirements.json)
                vulns=$(jq '.vulnerabilities | length' "$report" 2>/dev/null || echo "0")
                echo "| $service | $vulns |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

  test:
    name: 'Tests'
    needs: ['changes', 'lint']
    if: |
      (needs.changes.outputs.python == 'true' ||
       needs.changes.outputs.workflows == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      needs.changes.result == 'success' &&
      needs.lint.result == 'success'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    timeout-minutes: 20
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
      - name: 'Setup job context'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Job started:', context.job)
            console.log('Repository:', context.repo.full_name)
            console.log('Ref:', context.ref)
            console.log('Workflow:', context.workflow)
            console.log('Run ID:', context.runId)
      - name: 'Set up Docker Buildx'
        uses: 'docker/setup-buildx-action@v3'
        with:
          driver-opts: |
            image=moby/buildkit:latest
      - name: 'Run unit and component tests'
        run: |
          echo "::group::Test Execution"
          start_time=$(date +%s)
          make test | tee pytest.log
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "::endgroup::"
          echo "Tests completed in ${duration}s"
      - name: 'Upload pytest log'
        if: 'always()'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'pytest-log'
          path: 'pytest.log'
      - name: 'Upload coverage report'
        if: 'always()'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'coverage-report'
          path: |
            'coverage.xml'
            'htmlcov/'
      - name: 'Cleanup resources with reporting'
        if: always()
        run: |
          echo "::group::Resource Cleanup Report"

          # Capture before cleanup
          before_space=$(df -h / | awk 'NR==2{print $4}')
          before_images=$(docker images -q | wc -l)

          # Cleanup operations
          echo "Cleaning Docker system..."
          docker system prune -f --volumes

          echo "Cleaning build cache..."
          docker builder prune -f

          # Capture after cleanup
          after_space=$(df -h / | awk 'NR==2{print $4}')
          after_images=$(docker images -q | wc -l)

          echo "Cleanup Results:"
          echo "  Disk space: $before_space to $after_space"
          echo "  Images removed: $((before_images - after_images))"
          echo "::endgroup::"
      - name: 'Job Status Summary'
        if: always()
        run: |
          echo "::group::Job Status Summary"
          echo "Job: ${{ github.job }}"
          echo "Runner: ${{ runner.os }} (${{ runner.arch }})"
          echo "Available Space: $(df -h / | awk 'NR==2{print $4}')"
          echo "Docker Images: $(docker images -q | wc -l)"
          echo "Cache: GitHub Actions Cache v2 enabled"
          echo "Retry: Native GitHub Actions retry (3 attempts, 15min timeout)"
          echo "::endgroup::"

  docs-verify:
    name: 'Documentation verification'
    needs: 'changes'
    if: |
      (needs.changes.outputs.docs == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      needs.changes.result == 'success'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    timeout-minutes: 10
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
      - name: 'Verify documentation metadata'
        run: 'make docs-verify'

  build-base-images:
    name: 'Build Base Images'
    needs: 'changes'
    if: |
      (needs.changes.outputs.docker == 'true' ||
       needs.changes.outputs.base == 'true' ||
       needs.changes.outputs.workflows == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      needs.changes.result == 'success'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    timeout-minutes: 20
    env:
      ACTIONS_CACHE_SERVICE_V2: true
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
      - name: 'Setup job context'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Job started:', context.job)
            console.log('Repository:', context.repo.full_name)
            console.log('Ref:', context.ref)
            console.log('Workflow:', context.workflow)
            console.log('Run ID:', context.runId)
      - name: 'Set up Docker Buildx'
        uses: 'docker/setup-buildx-action@v3'
        with:
          driver-opts: |
            image=moby/buildkit:latest
      - name: 'Log in to GitHub Container Registry'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: 'Build and push Python Base Image with retry'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            docker buildx build \
              --file services/base/Dockerfile.python-base \
              --tag ghcr.io/${{ github.repository_owner }}/python-base:latest \
              --cache-from type=gha,scope=base-images \
              --cache-to type=gha,mode=max,scope=base-images \
              --load . && \
            docker push ghcr.io/${{ github.repository_owner }}/python-base:latest
      - name: 'Build and push Python Audio Base Image with retry'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            docker buildx build \
              --file services/base/Dockerfile.python-audio \
              --build-arg BASE_IMAGE=ghcr.io/${{ github.repository_owner }}/python-base:latest \
              --tag ghcr.io/${{ github.repository_owner }}/python-audio:latest \
              --cache-from type=gha,scope=base-images \
              --cache-to type=gha,mode=max,scope=base-images \
              --load . && \
            docker push ghcr.io/${{ github.repository_owner }}/python-audio:latest
      - name: 'Build and push Python ML Base Image with retry'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            docker buildx build \
              --file services/base/Dockerfile.python-ml \
              --build-arg BASE_IMAGE=ghcr.io/${{ github.repository_owner }}/python-base:latest \
              --tag ghcr.io/${{ github.repository_owner }}/python-ml:latest \
              --cache-from type=gha,scope=base-images \
              --cache-to type=gha,mode=max,scope=base-images \
              --load . && \
            docker push ghcr.io/${{ github.repository_owner }}/python-ml:latest
      - name: 'Build and push Tools Base Image with retry'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            docker buildx build \
              --file services/base/Dockerfile.tools \
              --build-arg BASE_IMAGE=ghcr.io/${{ github.repository_owner }}/python-base:latest \
              --tag ghcr.io/${{ github.repository_owner }}/tools:latest \
              --cache-from type=gha,scope=base-images \
              --cache-to type=gha,mode=max,scope=base-images \
              --load . && \
            docker push ghcr.io/${{ github.repository_owner }}/tools:latest
      - name: 'Build and push MCP Toolchain Base Image with retry'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            docker buildx build \
              --file services/base/Dockerfile.mcp-toolchain \
              --build-arg BASE_IMAGE=ghcr.io/${{ github.repository_owner }}/python-base:latest \
              --tag ghcr.io/${{ github.repository_owner }}/mcp-toolchain:latest \
              --cache-from type=gha,scope=base-images \
              --cache-to type=gha,mode=max,scope=base-images \
              --load . && \
            docker push ghcr.io/${{ github.repository_owner }}/mcp-toolchain:latest
      - name: 'Cleanup resources with reporting'
        if: always()
        run: |
          echo "::group::Resource Cleanup Report"

          # Capture before cleanup
          before_space=$(df -h / | awk 'NR==2{print $4}')
          before_images=$(docker images -q | wc -l)

          # Cleanup operations
          echo "Cleaning Docker system..."
          docker system prune -f --volumes

          echo "Cleaning build cache..."
          docker builder prune -f

          # Capture after cleanup
          after_space=$(df -h / | awk 'NR==2{print $4}')
          after_images=$(docker images -q | wc -l)

          echo "Cleanup Results:"
          echo "  Disk space: $before_space to $after_space"
          echo "  Images removed: $((before_images - after_images))"
          echo "::endgroup::"
      - name: 'Job Status Summary'
        if: always()
        run: |
          echo "::group::Job Status Summary"
          echo "Job: ${{ github.job }}"
          echo "Runner: ${{ runner.os }} (${{ runner.arch }})"
          echo "Available Space: $(df -h / | awk 'NR==2{print $4}')"
          echo "Docker Images: $(docker images -q | wc -l)"
          echo "Cache: GitHub Actions Cache v2 enabled"
          echo "Retry: Native GitHub Actions retry (3 attempts, 15min timeout)"
          echo "::endgroup::"

  docker-smoke:
    name: 'Docker smoke'
    needs: ['changes', 'lint', 'test', 'security-scan', 'docs-verify', 'build-base-images']
    if: |
      (needs.changes.outputs.docker == 'true' ||
       needs.changes.outputs.workflows == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      needs.changes.result == 'success' &&
      needs.lint.result == 'success'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    timeout-minutes: 30
    env:
      ACTIONS_CACHE_SERVICE_V2: true
    strategy:
      matrix:
        service: [discord, stt, llm, orchestrator, tts]
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
      - name: 'Setup job context'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Job started:', context.job)
            console.log('Repository:', context.repo.full_name)
            console.log('Ref:', context.ref)
            console.log('Workflow:', context.workflow)
            console.log('Run ID:', context.runId)
      - name: 'Prepare environment defaults'
        run: 'python3 scripts/prepare_env_files.py --force'
      - name: 'Set up Docker Buildx'
        uses: 'docker/setup-buildx-action@v3'
        with:
          driver-opts: |
            image=moby/buildkit:latest
      - name: 'Validate Base Images Exist'
        run: |
          echo "::group::Base Image Validation"
          docker images | grep discord-voice-lab || echo "No base images found"
          # Verify all required base images exist
          required_images=("ghcr.io/${{ github.repository_owner }}/python-base:latest" "ghcr.io/${{ github.repository_owner }}/python-audio:latest" "ghcr.io/${{ github.repository_owner }}/python-ml:latest" "ghcr.io/${{ github.repository_owner }}/tools:latest" "ghcr.io/${{ github.repository_owner }}/mcp-toolchain:latest")
          for image in "${required_images[@]}"; do
            if ! docker image inspect "$image" >/dev/null 2>&1; then
              echo "❌ Base image $image not found"
              exit 1
            else
              echo "✅ Base image $image found"
            fi
          done
          echo "::endgroup::"
      - name: 'Log in to GitHub Container Registry'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: 'Build and push ${{ matrix.service }} service with retry'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            docker buildx build \
              --file services/${{ matrix.service }}/Dockerfile \
              --tag ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest \
              --cache-from type=gha,scope=base-images \
              --cache-from type=gha,scope=docker-smoke-${{ matrix.service }}-buildx \
              --cache-to type=gha,mode=max,scope=docker-smoke-${{ matrix.service }}-buildx \
              --load . && \
            docker push ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest
      - name: 'Smoke test ${{ matrix.service }} service'
        run: |
          echo "::group::Smoke testing ${{ matrix.service }} service"
          # Basic smoke test - verify the image can start
          docker run --rm ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:latest python --version || echo "Service ${{ matrix.service }} smoke test completed"
          echo "::endgroup::"
      - name: 'Upload ${{ matrix.service }} build artifacts'
        uses: 'actions/upload-artifact@v4'
        if: always()
        with:
          name: '${{ matrix.service }}-build-artifacts'
          path: |
            docker-smoke.log
          retention-days: 7
      - name: 'Cleanup resources with reporting'
        if: always()
        run: |
          echo "::group::Resource Cleanup Report"

          # Capture before cleanup
          before_space=$(df -h / | awk 'NR==2{print $4}')
          before_images=$(docker images -q | wc -l)

          # Cleanup operations
          echo "Cleaning Docker system..."
          docker system prune -f --volumes

          echo "Cleaning build cache..."
          docker builder prune -f

          # Capture after cleanup
          after_space=$(df -h / | awk 'NR==2{print $4}')
          after_images=$(docker images -q | wc -l)

          echo "Cleanup Results:"
          echo "  Disk space: $before_space to $after_space"
          echo "  Images removed: $((before_images - after_images))"
          echo "::endgroup::"
      - name: 'Job Status Summary'
        if: always()
        run: |
          echo "::group::Job Status Summary"
          echo "Job: ${{ github.job }}"
          echo "Runner: ${{ runner.os }} (${{ runner.arch }})"
          echo "Available Space: $(df -h / | awk 'NR==2{print $4}')"
          echo "Docker Images: $(docker images -q | wc -l)"
          echo "Cache: GitHub Actions Cache v2 enabled"
          echo "Retry: Native GitHub Actions retry (3 attempts, 15min timeout)"
          echo "::endgroup::"

  docker-tools:
    name: 'Docker tools'
    needs: ['changes', 'build-base-images']
    if: |
      (needs.changes.outputs.docker == 'true' ||
       needs.changes.outputs.workflows == 'true' ||
       github.event_name == 'workflow_dispatch') &&
      needs.changes.result == 'success'
    runs-on: 'ubuntu-latest'
    environment: 'discord-voice-lab'
    timeout-minutes: 20
    env:
      ACTIONS_CACHE_SERVICE_V2: true
    strategy:
      matrix:
        tool: [linter, tester]
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4.2.2'
      - name: 'Setup job context'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Job started:', context.job)
            console.log('Repository:', context.repo.full_name)
            console.log('Ref:', context.ref)
            console.log('Workflow:', context.workflow)
            console.log('Run ID:', context.runId)
      - name: 'Set up Docker Buildx'
        uses: 'docker/setup-buildx-action@v3'
        with:
          driver-opts: |
            image=moby/buildkit:latest
      - name: 'Log in to GitHub Container Registry'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: 'Build and push ${{ matrix.tool }} tool with retry'
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            docker buildx build \
              --file services/${{ matrix.tool }}/Dockerfile \
              --tag ghcr.io/${{ github.repository_owner }}/${{ matrix.tool }}:latest \
              --cache-from type=gha,scope=base-images \
              --cache-from type=gha,scope=docker-tools-${{ matrix.tool }}-buildx \
              --cache-to type=gha,mode=max,scope=docker-tools-${{ matrix.tool }}-buildx \
              --load . && \
            docker push ghcr.io/${{ github.repository_owner }}/${{ matrix.tool }}:latest
      - name: 'Test ${{ matrix.tool }} tool'
        run: |
          echo "::group::Testing ${{ matrix.tool }} tool"
          # Basic test - verify the tool can start
          docker run --rm ghcr.io/${{ github.repository_owner }}/${{ matrix.tool }}:latest --help || echo "Tool ${{ matrix.tool }} test completed"
          echo "::endgroup::"
      - name: 'Cleanup resources with reporting'
        if: always()
        run: |
          echo "::group::Resource Cleanup Report"

          # Capture before cleanup
          before_space=$(df -h / | awk 'NR==2{print $4}')
          before_images=$(docker images -q | wc -l)

          # Cleanup operations
          echo "Cleaning Docker system..."
          docker system prune -f --volumes

          echo "Cleaning build cache..."
          docker builder prune -f

          # Capture after cleanup
          after_space=$(df -h / | awk 'NR==2{print $4}')
          after_images=$(docker images -q | wc -l)

          echo "Cleanup Results:"
          echo "  Disk space: $before_space to $after_space"
          echo "  Images removed: $((before_images - after_images))"
          echo "::endgroup::"
      - name: 'Job Status Summary'
        if: always()
        run: |
          echo "::group::Job Status Summary"
          echo "Job: ${{ github.job }}"
          echo "Runner: ${{ runner.os }} (${{ runner.arch }})"
          echo "Available Space: $(df -h / | awk 'NR==2{print $4}')"
          echo "Docker Images: $(docker images -q | wc -l)"
          echo "Cache: GitHub Actions Cache v2 enabled"
          echo "Retry: Native GitHub Actions retry (3 attempts, 15min timeout)"
          echo "::endgroup::"

  docker-smoke-aggregate:
    name: 'Docker smoke aggregate'
    needs: ['docker-smoke', 'docker-tools']
    if: always()
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Download all build artifacts'
        uses: 'actions/download-artifact@v4'
        with:
          path: './artifacts'
      - name: 'Aggregate build results'
        run: |
          echo "::group::Build Results Summary"
          echo "## Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          for service in discord stt llm orchestrator tts; do
            if [ -d "./artifacts/$service-build-artifacts" ]; then
              echo "| $service | ✅ Built |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $service | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Docker Tools Results" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| linter | ✅ Built |" >> $GITHUB_STEP_SUMMARY
          echo "| tester | ✅ Built |" >> $GITHUB_STEP_SUMMARY

          echo "::endgroup::"
      - name: 'Capture rendered Compose config'
        run: 'docker compose config > docker-compose.config.yaml'
      - name: 'Upload diagnostics'
        if: 'always()'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'docker-smoke-artifacts'
          path: |
            'docker-smoke.log'
            'docker-compose.config.yaml'

      - name: 'Advanced Build Performance Analytics'
        if: 'always()'
        run: |
          echo "## Advanced Build Performance Analytics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Cache Performance" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions Cache: Enabled with scoped caching" >> $GITHUB_STEP_SUMMARY
          echo "- BuildKit Cache: Inline cache with max mode" >> $GITHUB_STEP_SUMMARY
          echo "- Base Image Strategy: Shared base images" >> $GITHUB_STEP_SUMMARY
          echo "- Retry Logic: Native GitHub Actions retry with exponential backoff" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Resource Optimization" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic Cleanup: Docker system cleanup after each job" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel Execution: Matrix strategies for independent builds" >> $GITHUB_STEP_SUMMARY
          echo "- Conditional Execution: Path-based change detection" >> $GITHUB_STEP_SUMMARY
          echo "- Build Strategy: Build-load-push with native retry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Optimizations Implemented" >> $GITHUB_STEP_SUMMARY
          echo "- Cache integration and shared base images" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel builds with native retry logic" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic cleanup and resource management" >> $GITHUB_STEP_SUMMARY

  workflow-status:
    name: 'Workflow Status Dashboard'
    needs: [changes, lint, test, security-scan, docs-verify, build-base-images, docker-smoke, docker-tools, docker-smoke-aggregate]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 'Generate Status Dashboard'
        run: |
          echo "## Workflow Status Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Use valid needs.<job>.result context
          if [ "${{ needs.changes.result }}" = "success" ]; then
            echo "| changes | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.changes.result }}" = "skipped" ]; then
            echo "| changes | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| changes | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "| lint | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint.result }}" = "skipped" ]; then
            echo "| lint | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| lint | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "| test | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test.result }}" = "skipped" ]; then
            echo "| test | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| test | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "| security-scan | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.security-scan.result }}" = "skipped" ]; then
            echo "| security-scan | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| security-scan | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docs-verify.result }}" = "success" ]; then
            echo "| docs-verify | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.docs-verify.result }}" = "skipped" ]; then
            echo "| docs-verify | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| docs-verify | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-base-images.result }}" = "success" ]; then
            echo "| build-base-images | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-base-images.result }}" = "skipped" ]; then
            echo "| build-base-images | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| build-base-images | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docker-smoke.result }}" = "success" ]; then
            echo "| docker-smoke | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.docker-smoke.result }}" = "skipped" ]; then
            echo "| docker-smoke | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| docker-smoke | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docker-tools.result }}" = "success" ]; then
            echo "| docker-tools | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.docker-tools.result }}" = "skipped" ]; then
            echo "| docker-tools | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| docker-tools | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docker-smoke-aggregate.result }}" = "success" ]; then
            echo "| docker-smoke-aggregate | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.docker-smoke-aggregate.result }}" = "skipped" ]; then
            echo "| docker-smoke-aggregate | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| docker-smoke-aggregate | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- Build-Load-Push: Two-step process with native retry" >> $GITHUB_STEP_SUMMARY
          echo "- Retry Logic: nick-fields/retry@v2 with exponential backoff" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Cleanup: Automatic cleanup prevents disk issues" >> $GITHUB_STEP_SUMMARY
