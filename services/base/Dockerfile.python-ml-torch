# Phase 2: Python ML Base with PyTorch Optimization
# Consolidates PyTorch dependencies for STT, LLM-FLAN, Guardrails, TTS-Bark

FROM ghcr.io/gabrielpreston/python-ml:latest

WORKDIR /app

# Install PyTorch and related dependencies
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir \
    torch>=2.0,<3.0 \
    torchvision>=0.15,<1.0 \
    torchaudio>=2.0,<3.0 \
    --index-url https://download.pytorch.org/whl/cpu

# Install common ML dependencies
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir \
    transformers>=4.57,<5.0 \
    accelerate>=0.20,<1.0 \
    safetensors>=0.3,<1.0

# Set environment variables for PyTorch optimization
ENV TORCH_CUDA_ARCH_LIST=""
ENV TORCH_USE_CUDA_DETERMINISTIC=1
ENV PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:128

# Create models directory
RUN mkdir -p /app/models

# Set Python environment variables
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import torch; print('PyTorch version:', torch.__version__)"

LABEL phase="2" \
    optimization="torch-consolidation" \
    dependencies="pytorch,transformers,accelerate"
