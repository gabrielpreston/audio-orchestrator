# Phase 2: Python ML Base with Transformers Optimization
# Adds NLP-specific dependencies and optimizations for LLM-FLAN, Guardrails

FROM ghcr.io/gabrielpreston/python-ml:latest

WORKDIR /app

# Install additional NLP and evaluation dependencies
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir \
    "datasets>=2.0,<3.0" \
    "evaluate>=0.4,<1.0" \
    "rouge-score>=0.1,<1.0" \
    "bleu-score>=0.1,<1.0" \
    "nltk>=3.8,<4.0" && \
    # Clean up pip cache to save disk space
    pip cache purge || true

# Set environment variables for Transformers optimization
ENV TRANSFORMERS_CACHE=/app/models
ENV HF_HOME=/app/models
ENV HF_DATASETS_CACHE=/app/models

# Create models directory
RUN mkdir -p /app/models

# Set Python environment variables
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import transformers, datasets; print('NLP ecosystem loaded successfully')"

LABEL phase="2" \
    optimization="nlp-ecosystem" \
    dependencies="transformers,datasets,evaluate,rouge" \
    compilation="optimized"
