version: "3.8"
services:
  # Enhanced AI Services
  guardrails:
    build:
      context: "."
      dockerfile: "services/guardrails/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/guardrails:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/guardrails:latest"
    ports:
      - "9310:9300" # External: 9310, Internal: 9300
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/guardrails/.env.service"
    environment:
      - TOXICITY_MODEL=unitary/toxic-bert
      - ENABLE_PII_DETECTION=true
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:9300/health/ready",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 1G # Toxicity detection (optimized)
          cpus: "1"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  orchestrator:
    build:
      context: "."
      dockerfile: "services/orchestrator/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/orchestrator:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/orchestrator:latest"
    ports:
      - "8220:8200" # External: 8220, Internal: 8200
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/orchestrator/.env.service"
    environment:
      - LLM_PRIMARY_URL=http://flan:8100
      - GUARDRAILS_URL=http://guardrails:9300
    depends_on:
      flan:
        condition: service_healthy
      guardrails:
        condition: service_healthy
      # Remove stt and audio dependencies - orchestrator doesn't directly need them
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:8200/health/ready",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G # LangChain + overhead (optimized)
          cpus: "2"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  flan:
    build:
      context: "."
      dockerfile: "services/flan/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/flan:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/flan:latest"
    ports:
      - "8110:8100" # External: 8110, Internal: 8100
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/flan/.env.service"
    environment:
      - MODEL_NAME=${FLAN_T5_MODEL_SIZE:-google/flan-t5-large}
      - TRANSFORMERS_CACHE=/app/models
    volumes:
      - ./services/models/flan-t5:/app/models:ro
      - ~/.cache/huggingface:/root/.cache/huggingface:ro
    # No dependencies - FLAN-T5 is standalone
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:8100/health/ready",
          "--timeout",
          "10",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    deploy:
      resources:
        limits:
          memory: 10G # Optimized for FLAN-T5 Large + overhead
          cpus: "4"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
  audio:
    build:
      context: "."
      dockerfile: "services/audio/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/audio:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/audio:latest"
    ports:
      - "8010:9100"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/audio/.env.service"
    volumes:
      - "./debug:/app/debug"
      - "./services/audio/config:/app/config"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:9100/health/ready",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G # Audio processing
          cpus: "1"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  discord:
    build:
      context: "."
      dockerfile: "services/discord/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-audio:latest
        - ghcr.io/gabrielpreston/discord:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/discord:latest"
    ports:
      - "8009:8001"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/discord/.env.service"
    volumes:
      - "./debug:/app/debug"
    healthcheck:
      test: >
        ["CMD", "python", "/app/scripts/health_check.py",
         "http://localhost:8001/health/ready", "--timeout", "5"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 45s
    depends_on:
      audio:
        condition: service_healthy
      stt:
        condition: service_healthy
      orchestrator:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G # Discord bot + voice processing
          cpus: "1"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  stt:
    build:
      context: "."
      dockerfile: "services/stt/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/stt:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/stt:latest"
    ports:
      - "8011:9000"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/stt/.env.service"
    volumes:
      - "./services/models/stt:/app/models:ro"
      - "./debug:/app/debug"
    healthcheck:
      test: >
        ["CMD", "python", "/app/scripts/health_check.py",
         "http://localhost:9000/health/ready", "--timeout", "5"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 120s
    depends_on:
      audio:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 2G # STT with faster-whisper models
          cpus: "2"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Bark TTS Service
  bark:
    build:
      context: "."
      dockerfile: "services/bark/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/bark:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/bark:latest"
    ports:
      - "7120:7100" # External: 7120, Internal: 7100
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/bark/.env.service"
    environment:
      - BARK_USE_SMALL_MODELS=false
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:7100/health/ready",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 4G # Optimized for Bark
          cpus: "2"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  testing:
    build:
      context: "."
      dockerfile: "services/testing/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/testing:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/testing:latest"
    ports:
      - "8080:8080" # External: 8080, Internal: 8080
    env_file:
      - "./.env.common"
      - "./.env.docker"
    environment:
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=8080
      - AUDIO_PREPROCESSOR_URL=http://audio:9100
      - STT_URL=http://stt:9000
      - ORCHESTRATOR_URL=http://orchestrator:8200
      - BARK_URL=http://bark:7100
    depends_on:
      audio:
        condition: service_healthy
      stt:
        condition: service_healthy
      orchestrator:
        condition: service_healthy
      bark:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:8081/health/ready",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  monitoring:
    build:
      context: "."
      dockerfile: "services/monitoring/Dockerfile"
      cache_from:
        - type=gha,scope=services
        - ghcr.io/gabrielpreston/python-ml:latest
        - ghcr.io/gabrielpreston/monitoring:latest
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/monitoring:latest"
    ports:
      - "8501:8501" # External: 8501, Internal: 8501
    env_file:
      - "./.env.common"
      - "./.env.docker"
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:8501/health/ready",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Observability Stack - INDEPENDENT INFRASTRUCTURE
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.91.0
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./config/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "8889:8889" # Prometheus metrics exporter
      - "13133:13133" # Health check
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:13133/",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  prometheus:
    image: prom/prometheus:v2.48.0
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:9090/-/healthy",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  jaeger:
    image: jaegertracing/all-in-one:1.52
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=memory
    ports:
      - "16686:16686" # Jaeger UI
      - "14250:14250" # gRPC
      - "14268:14268" # HTTP
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:16686/",
          "--timeout",
          "5",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    image: grafana/grafana:10.2.2
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      # Mount entire config directory instead of individual files
      - ./config/grafana:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  prometheus-data: {}
  grafana-data: {}
  # Shared pip cache for faster builds across services
  pip-cache:
    driver: local
