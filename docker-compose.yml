version: "3.8"
services:
  audio-processor:
    build:
      context: "."
      dockerfile: "services/audio-processor/Dockerfile"
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/audio-processor:latest"
    ports:
      - "8010:9100"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/audio-processor/.env.service"
    volumes:
      - "./debug:/app/debug"
      - "./services/audio-processor/config:/app/config"
    healthcheck:
      test: >
        ["CMD", "curl", "-f", "http://localhost:9100/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  discord:
    build:
      context: "."
      dockerfile: "services/discord/Dockerfile"
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/discord:latest"
    ports:
      - "8009:8001"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/discord/.env.service"
    volumes:
      - "./debug:/app/debug"
    healthcheck:
      test: >
        ["CMD", "python", "/app/scripts/health_check.py",
         "http://localhost:8001/health/ready", "--timeout", "5"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 45s
    depends_on:
      audio-processor:
        condition: service_healthy
      stt:
        condition: service_healthy
      orchestrator:
        condition: service_healthy
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  stt:
    build:
      context: "."
      dockerfile: "services/stt/Dockerfile"
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/stt:latest"
    ports:
      - "8011:9000"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/stt/.env.service"
    volumes:
      - "./services/models/stt:/app/models:ro"
      - "./debug:/app/debug"
    healthcheck:
      test: >
        ["CMD", "python", "/app/scripts/health_check.py",
         "http://localhost:9000/health/ready", "--timeout", "5"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      audio-processor:
        condition: service_healthy
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  llm:
    build:
      context: "."
      dockerfile: "services/llm/Dockerfile"
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/llm:latest"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/llm/.env.service"
    ports:
      - "8017:8000"
    volumes:
      - "./services/models/llm:/app/models:ro"
      - "./debug:/app/debug"
    healthcheck:
      test: >
        ["CMD", "python", "/app/scripts/health_check.py",
         "http://localhost:8000/health/ready", "--timeout", "5"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  orchestrator:
    build:
      context: "."
      dockerfile: "services/orchestrator/Dockerfile"
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/orchestrator:latest"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/orchestrator/.env.service"
    ports:
      - "8023:8000"
    volumes:
      - "./mcp.json:/app/mcp.json:ro"
      - "./services/discord:/app/services/discord:ro"
      - "./debug:/app/debug"
    healthcheck:
      test: >
        ["CMD", "python", "/app/scripts/health_check.py",
         "http://localhost:8000/health/ready", "--timeout", "5"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      llm:
        condition: service_healthy
      tts:
        condition: service_healthy
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  tts:
    build:
      context: "."
      dockerfile: "services/tts/Dockerfile"
      args:
        BUILDKIT_INLINE_CACHE: "1"
    image: "ghcr.io/gabrielpreston/tts:latest"
    env_file:
      - "./.env.common"
      - "./.env.docker"
      - "./services/tts/.env.service"
    ports:
      - "8027:7000"
    volumes:
      - "./services/models/tts:/app/models:ro"
      - "./debug:/app/debug"
    healthcheck:
      test: >
        ["CMD", "python", "/app/scripts/health_check.py",
         "http://localhost:7000/health/ready", "--timeout", "5"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: "unless-stopped"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
