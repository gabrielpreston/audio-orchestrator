# Test-specific Docker Compose configuration
# Optimized for integration testing with fast startup and isolated network
version: "3.8"

networks:
  test-network:
    driver: bridge
    name: audio-orchestrator-test

services:
  audio-processor:
    extends:
      file: docker-compose.yml
      service: audio-processor
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  stt:
    extends:
      file: docker-compose.yml
      service: stt
    networks:
      - test-network
    environment:
      - FW_MODEL=tiny # Fast model for tests
      - LOG_LEVEL=INFO
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:9000/health/ready",
          "--timeout",
          "3",
        ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    volumes:
      - ./services/tests/fixtures:/app/test-fixtures:ro

  tts-bark:
    extends:
      file: docker-compose.yml
      service: tts-bark
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - TTS_AUTH_TOKEN=test-token
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:7100/health/ready",
          "--timeout",
          "3",
        ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    volumes:
      - ./services/tests/fixtures:/app/test-fixtures:ro

  llm-flan:
    extends:
      file: docker-compose.yml
      service: llm-flan
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - LLM_AUTH_TOKEN=test-token
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:8100/health/ready",
          "--timeout",
          "3",
        ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  orchestrator-enhanced:
    extends:
      file: docker-compose.yml
      service: orchestrator-enhanced
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - LLM_AUTH_TOKEN=test-token
      - TTS_AUTH_TOKEN=test-token
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:8200/health/ready",
          "--timeout",
          "3",
        ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    depends_on:
      llm-flan:
        condition: service_healthy
      tts-bark:
        condition: service_healthy

  # Discord service for E2E tests (optional, requires token)
  discord:
    build:
      context: .
      dockerfile: services/discord/Dockerfile
    networks:
      - test-network
    ports:
      - "8001:8001" # Discord HTTP API port
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN:-dummy-token-for-testing}
      - DISCORD_FULL_BOT=false # HTTP mode by default (correct env var name)
      - DISCORD_GUILD_ID=123456789
      - DISCORD_VOICE_CHANNEL_ID=987654321
      - STT_BASE_URL=http://stt:9000
      - ORCHESTRATOR_BASE_URL=http://orchestrator:8200
      - LOG_LEVEL=INFO
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "/app/scripts/health_check.py",
          "http://localhost:8001/health/ready",
          "--timeout",
          "3",
        ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    depends_on:
      stt:
        condition: service_healthy
      orchestrator-enhanced:
        condition: service_healthy
