# Test-specific Docker Compose configuration
# Optimized for integration testing with fast startup and isolated network
# Includes full stack for comprehensive integration testing

networks:
  test-network:
    driver: bridge
    name: audio-orchestrator-test

services:
  # Core Services
  audio:
    extends:
      file: docker-compose.yml
      service: audio
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO

  stt:
    extends:
      file: docker-compose.yml
      service: stt
    networks:
      - test-network
    environment:
      - FW_MODEL=tiny # Fast model for tests
      - LOG_LEVEL=INFO
    volumes:
      - ./services/tests/fixtures:/app/test-fixtures:ro

  bark:
    extends:
      file: docker-compose.yml
      service: bark
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - TTS_AUTH_TOKEN=test-token
    volumes:
      - ./services/tests/fixtures:/app/test-fixtures:ro

  flan:
    extends:
      file: docker-compose.yml
      service: flan
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - LLM_AUTH_TOKEN=test-token

  guardrails:
    extends:
      file: docker-compose.yml
      service: guardrails
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO

  orchestrator:
    extends:
      file: docker-compose.yml
      service: orchestrator
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - LLM_BASE_URL=http://flan:8100
      - TTS_BASE_URL=http://bark:7100  # Explicit service URL (agnostic name)
      - GUARDRAILS_BASE_URL=http://guardrails:9300
      - LLM_AUTH_TOKEN=test-token
      - TTS_AUTH_TOKEN=test-token

  # Discord service for E2E tests (optional, requires token)
  discord:
    extends:
      file: docker-compose.yml
      service: discord
    networks:
      - test-network
    ports:
      - "8001:8001" # Discord HTTP API port
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN:-dummy-token-for-testing}
      - DISCORD_FULL_BOT=false # HTTP mode by default (correct env var name)
      - DISCORD_GUILD_ID=123456789
      - DISCORD_VOICE_CHANNEL_ID=987654321
      - STT_BASE_URL=http://stt:9000
      - ORCHESTRATOR_BASE_URL=http://orchestrator:8200
      - LOG_LEVEL=INFO

  # Testing service (Gradio UI)
  testing:
    extends:
      file: docker-compose.yml
      service: testing
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - AUDIO_BASE_URL=http://audio:9100
      - STT_BASE_URL=http://stt:9000
      - ORCHESTRATOR_BASE_URL=http://orchestrator:8200
      - TTS_BASE_URL=http://bark:7100

  # Monitoring service
  monitoring:
    extends:
      file: docker-compose.yml
      service: monitoring
    networks:
      - test-network
    environment:
      - LOG_LEVEL=INFO
      - PROMETHEUS_URL=http://prometheus:9090

  # Observability Stack
  otel-collector:
    extends:
      file: docker-compose.yml
      service: otel-collector
    networks:
      - test-network

  prometheus:
    extends:
      file: docker-compose.yml
      service: prometheus
    networks:
      - test-network
    volumes:
      - prometheus-test-data:/prometheus

  jaeger:
    extends:
      file: docker-compose.yml
      service: jaeger
    networks:
      - test-network

  grafana:
    extends:
      file: docker-compose.yml
      service: grafana
    networks:
      - test-network
    volumes:
      - grafana-test-data:/var/lib/grafana

volumes:
  prometheus-test-data: {}
  grafana-test-data: {}
